<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=iso-8859-1" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of exceptions" rel=Appendix href="index_exceptions.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="Promiwag" rel="Chapter" href="Promiwag.html">
<link title="Promiwag_Yaboon_PolyComp" rel="Chapter" href="Promiwag_Yaboon_PolyComp.html">
<link title="Promiwag_c_backend" rel="Chapter" href="Promiwag_c_backend.html">
<link title="Promiwag_meta_packet" rel="Chapter" href="Promiwag_meta_packet.html">
<link title="Promiwag_pcap_boilerplate" rel="Chapter" href="Promiwag_pcap_boilerplate.html">
<link title="Promiwag_platform" rel="Chapter" href="Promiwag_platform.html">
<link title="Promiwag_protocol_stack" rel="Chapter" href="Promiwag_protocol_stack.html">
<link title="Promiwag_standard_protocols" rel="Chapter" href="Promiwag_standard_protocols.html">
<link title="Promiwag_std" rel="Chapter" href="Promiwag_std.html">
<link title="Promiwag_stiel" rel="Chapter" href="Promiwag_stiel.html">
<link title="Promiwag_stiel_backends" rel="Chapter" href="Promiwag_stiel_backends.html"><title>Promiwag Library : Promiwag_stiel_backends.To_C.printf_of_log</title>
</head>
<body>
<code class="code"><span class="keyword">let</span>&nbsp;printf_of_log&nbsp;compiler&nbsp;format&nbsp;te_list&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;escape&nbsp;=&nbsp;<span class="string">"AROBASEESCAPE4732992387737238292933"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fmt&nbsp;=&nbsp;ref&nbsp;(<span class="constructor">Str</span>.multi_replace&nbsp;~str:format&nbsp;~sub:<span class="string">"@@"</span>&nbsp;~by:escape)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;arg_list&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ls</span>.map&nbsp;te_list&nbsp;~f:(<span class="keyword">fun</span>&nbsp;te&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;type_fmt&nbsp;lfmt&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;ux&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;te&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Typed_int</span>&nbsp;(<span class="constructor">Type_uint8</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="string">"%hhu"</span>,&nbsp;<span class="string">"%02hhx"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Typed_int</span>&nbsp;(<span class="constructor">Type_uint16</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="string">"%hu"</span>&nbsp;,&nbsp;<span class="string">"%04hx"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Typed_int</span>&nbsp;(<span class="constructor">Type_uint32</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="string">"%u"</span>&nbsp;&nbsp;,&nbsp;<span class="string">"%08x"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Typed_int</span>&nbsp;(<span class="constructor">Type_uint64</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="string">"%llu"</span>,&nbsp;<span class="string">"%16llx"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Typed_int</span>&nbsp;(<span class="constructor">Type_uint_native</span>,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="string">"%lu"</span>&nbsp;,&nbsp;<span class="string">"%16lx"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Typed_bool</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_&nbsp;&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(<span class="string">"%d"</span>,&nbsp;<span class="string">"%x"</span>)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Typed_buffer</span>&nbsp;(t,&nbsp;_)&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;&nbsp;(<span class="string">"%lu"</span>,&nbsp;<span class="string">"%lx"</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;lfmt&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"@int"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fst&nbsp;ux<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"@hex"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;snd&nbsp;ux&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"@expr"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<span class="string">"%s"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;_&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fail&nbsp;compiler&nbsp;<span class="string">"Do_log:&nbsp;should&nbsp;not&nbsp;be&nbsp;here&nbsp;(type_fmt)"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;try_the_patterns&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ls</span>.map&nbsp;&nbsp;[<span class="string">"@int"</span>;&nbsp;<span class="string">"@hex"</span>;&nbsp;<span class="string">"@expr"</span>&nbsp;]&nbsp;&nbsp;~f:(<span class="keyword">fun</span>&nbsp;pat&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;index&nbsp;=&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Str</span>.find&nbsp;!fmt&nbsp;pat&nbsp;<span class="keyword">with</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;max_int&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(index,&nbsp;pat))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;_,&nbsp;the_first&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ls</span>.fold_left&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(cur_index,&nbsp;cur_pat)&nbsp;(index,&nbsp;pat)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;cur_index&nbsp;&gt;&nbsp;index&nbsp;<span class="keyword">then</span>&nbsp;(index,&nbsp;pat)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;(cur_index,&nbsp;cur_pat))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~init:(max_int,&nbsp;<span class="string">"none"</span>)&nbsp;try_the_patterns&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;sub,&nbsp;by&nbsp;=&nbsp;the_first,&nbsp;(type_fmt&nbsp;the_first)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;the_first&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"none"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;fail&nbsp;compiler&nbsp;<span class="string">"Do_log:&nbsp;format&nbsp;does&nbsp;not&nbsp;match&nbsp;arg&nbsp;list"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"@int"</span>&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"@hex"</span>&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fmt&nbsp;:=&nbsp;snd&nbsp;(<span class="constructor">Str</span>.replace&nbsp;~str:!fmt&nbsp;~sub&nbsp;~by);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;typed_expression&nbsp;compiler&nbsp;te<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="string">"@expr"</span>&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fmt&nbsp;:=&nbsp;snd&nbsp;(<span class="constructor">Str</span>.replace&nbsp;~str:!fmt&nbsp;~sub&nbsp;~by);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">`</span>literal_string&nbsp;(<span class="constructor">To_string</span>.typed_expression&nbsp;te)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;&nbsp;s&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fail&nbsp;compiler&nbsp;(sprintf&nbsp;<span class="string">"Do_log:&nbsp;should&nbsp;not&nbsp;be&nbsp;here&nbsp;(arg_list):&nbsp;%s"</span>&nbsp;s)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;fmt&nbsp;:=&nbsp;(<span class="constructor">Str</span>.multi_replace&nbsp;~str:!fmt&nbsp;~sub:escape&nbsp;~by:<span class="string">"@"</span>);<br>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keywordsign">`</span>expression&nbsp;(<span class="keywordsign">`</span>cast&nbsp;(<span class="keywordsign">`</span>void,&nbsp;<span class="keywordsign">`</span>call&nbsp;(<span class="keywordsign">`</span>variable&nbsp;<span class="string">"printf"</span>,&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="keywordsign">`</span>literal_string&nbsp;!fmt)&nbsp;::&nbsp;arg_list))))</code></body></html>