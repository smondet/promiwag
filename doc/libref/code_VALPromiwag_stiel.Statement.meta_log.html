<html><head>
<link rel="stylesheet" href="style.css" type="text/css">
<meta content="text/html; charset=iso-8859-1" http-equiv="Content-Type">
<link rel="Start" href="index.html">
<link title="Index of types" rel=Appendix href="index_types.html">
<link title="Index of exceptions" rel=Appendix href="index_exceptions.html">
<link title="Index of values" rel=Appendix href="index_values.html">
<link title="Index of modules" rel=Appendix href="index_modules.html">
<link title="Index of module types" rel=Appendix href="index_module_types.html">
<link title="Promiwag" rel="Chapter" href="Promiwag.html">
<link title="Promiwag_Yaboon_PolyComp" rel="Chapter" href="Promiwag_Yaboon_PolyComp.html">
<link title="Promiwag_c_backend" rel="Chapter" href="Promiwag_c_backend.html">
<link title="Promiwag_meta_packet" rel="Chapter" href="Promiwag_meta_packet.html">
<link title="Promiwag_pcap_boilerplate" rel="Chapter" href="Promiwag_pcap_boilerplate.html">
<link title="Promiwag_platform" rel="Chapter" href="Promiwag_platform.html">
<link title="Promiwag_protocol_stack" rel="Chapter" href="Promiwag_protocol_stack.html">
<link title="Promiwag_standard_protocols" rel="Chapter" href="Promiwag_standard_protocols.html">
<link title="Promiwag_std" rel="Chapter" href="Promiwag_std.html">
<link title="Promiwag_stiel" rel="Chapter" href="Promiwag_stiel.html">
<link title="Promiwag_stiel_backends" rel="Chapter" href="Promiwag_stiel_backends.html"><title>Promiwag Library : Promiwag_stiel.Statement.meta_log</title>
</head>
<body>
<code class="code"><span class="keyword">let</span>&nbsp;meta_log&nbsp;user_printers&nbsp;format&nbsp;te_list&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;double_escape&nbsp;=&nbsp;<span class="string">"AROBASEESCAPE4732992387737238292933"</span>&nbsp;<span class="keyword">in</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;simple_escape&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf&nbsp;<span class="string">"9sdfa9dsg3gfds8gfdsggfdsgfdsgfdsgfdsgfdsgfdsgfds33%s"</span>&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;standard_printers&nbsp;=&nbsp;[<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="string">"@hex"</span>,&nbsp;simple_escape&nbsp;<span class="string">"hex"</span>,&nbsp;<span class="keyword">fun</span>&nbsp;te&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[te]);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="string">"@int"</span>,&nbsp;simple_escape&nbsp;<span class="string">"int"</span>,&nbsp;<span class="keyword">fun</span>&nbsp;te&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[te]);<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="string">"@expr"</span>,simple_escape&nbsp;<span class="string">"expr"</span>,&nbsp;<span class="keyword">fun</span>&nbsp;te&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;[te]);&nbsp;]&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;all_printers&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;standard_printers&nbsp;@&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Ls</span>.map&nbsp;user_printers&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(a,b,c)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;newb&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Str</span>.multi_replace&nbsp;~str:b&nbsp;~sub:<span class="string">"@"</span>&nbsp;~by:(simple_escape&nbsp;<span class="string">""</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(a,&nbsp;newb,&nbsp;c)))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;unescape&nbsp;str&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;str&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Str</span>.multi_replace&nbsp;~str&nbsp;~sub:(simple_escape&nbsp;<span class="string">""</span>)&nbsp;~by:<span class="string">"@"</span>)&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Str</span>.multi_replace&nbsp;~str&nbsp;~sub:double_escape&nbsp;~by:<span class="string">"@@"</span>&nbsp;<span class="keyword">in</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;first_pattern&nbsp;fmt&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;try_the_patterns&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ls</span>.map&nbsp;all_printers&nbsp;~f:(<span class="keyword">fun</span>&nbsp;((pat,&nbsp;replace,&nbsp;te_fun)&nbsp;<span class="keyword">as</span>&nbsp;printer)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;index&nbsp;=&nbsp;<span class="keyword">try</span>&nbsp;<span class="constructor">Str</span>.find&nbsp;fmt&nbsp;pat&nbsp;<span class="keyword">with</span>&nbsp;e&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;max_int&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(index,&nbsp;printer))&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;_,&nbsp;the_first&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Ls</span>.fold_left&nbsp;~f:(<span class="keyword">fun</span>&nbsp;(cur_index,&nbsp;cur_prt)&nbsp;(index,&nbsp;prt)&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>&nbsp;cur_index&nbsp;&gt;&nbsp;index&nbsp;<span class="keyword">then</span>&nbsp;(index,&nbsp;<span class="constructor">Some</span>&nbsp;prt)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">else</span>&nbsp;(cur_index,&nbsp;cur_prt))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;~init:(max_int,&nbsp;<span class="constructor">None</span>)&nbsp;try_the_patterns&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the_first<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;<span class="keyword">rec</span>&nbsp;parse_string&nbsp;te_list_list&nbsp;te_list&nbsp;str&nbsp;=<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">match</span>&nbsp;first_pattern&nbsp;str,&nbsp;te_list&nbsp;<span class="keyword">with</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>,&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span>&nbsp;(str,&nbsp;<span class="constructor">Ls</span>.flatten&nbsp;(<span class="constructor">Ls</span>.rev&nbsp;te_list_list))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;(sub,&nbsp;by,&nbsp;te_fun),&nbsp;te&nbsp;::&nbsp;next_tes&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(parse_string&nbsp;((te_fun&nbsp;te)&nbsp;::&nbsp;te_list_list)<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next_tes&nbsp;(snd&nbsp;(<span class="constructor">Str</span>.replace&nbsp;~str&nbsp;~sub&nbsp;~by)))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">None</span>,&nbsp;l&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwith&nbsp;<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(sprintf&nbsp;<span class="string">"meta_log:&nbsp;too&nbsp;many&nbsp;arguments&nbsp;(%d)&nbsp;and&nbsp;no&nbsp;more&nbsp;patterns:&nbsp;%S"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="constructor">Ls</span>.length&nbsp;l)&nbsp;(unescape&nbsp;str))<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keywordsign">|</span>&nbsp;<span class="constructor">Some</span>&nbsp;(sub,&nbsp;by,&nbsp;_),&nbsp;[]&nbsp;<span class="keywordsign">-&gt;</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;failwith<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(sprintf&nbsp;<span class="string">"meta_log:&nbsp;not&nbsp;enough&nbsp;arguments&nbsp;for&nbsp;all&nbsp;the&nbsp;patterns:&nbsp;'%s'&nbsp;in&nbsp;%S"</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sub&nbsp;(unescape&nbsp;str))<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;fmt&nbsp;=&nbsp;<span class="constructor">Str</span>.multi_replace&nbsp;~str:format&nbsp;~sub:<span class="string">"@@"</span>&nbsp;~by:double_escape&nbsp;<span class="keyword">in</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;new_format,&nbsp;new_args&nbsp;=&nbsp;parse_string&nbsp;[]&nbsp;te_list&nbsp;fmt&nbsp;<span class="keyword">in</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">let</span>&nbsp;actually_the_format&nbsp;=&nbsp;unescape&nbsp;new_format&nbsp;<span class="keyword">in</span><br>
<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="constructor">Do_log</span>&nbsp;(actually_the_format,&nbsp;new_args)</code></body></html>